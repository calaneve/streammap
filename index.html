<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Reach Map - Stream Grades with Hover Tooltip</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    #searchBox, #gradeColumn, #updateButton {
      position: absolute;
      right: 20px;
      z-index: 1001;
      padding: 6px;
      font-size: 14px;
      width: 200px;
      background: white;
      border: 1px solid #ccc;
    }
    #searchBox { top: 20px; }
    #gradeColumn { top: 60px; }
    #updateButton { top: 100px; cursor: pointer; background: #f0f0f0; }
    #gradeFilter, #reachFilter, #layerToggle {
      position: absolute;
      right: 20px;
      z-index: 1001;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }
    #gradeFilter { top: 150px; }
    #reachFilter { top: 330px; max-height: 300px; overflow-y: auto; }
    #layerToggle { top: 640px; }
    .legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      font-family: Arial, sans-serif;
      font-size: 14px;
      z-index: 1000;
    }
    .legend i {
      width: 14px;
      height: 14px;
      float: left;
      margin-right: 8px;
      margin-top: 2px;
      opacity: 0.8;
    }
    .legend div { clear: both; margin-bottom: 4px; }
  </style>
</head>
<body>
  <input type="text" id="searchBox" placeholder="Search Reach ID...">
  <select id="gradeColumn"></select>
  <button id="updateButton">Update Map</button>
  <div id="gradeFilter">
    <label><input type="checkbox" value="F" checked> F</label><br>
    <label><input type="checkbox" value="D" checked> D</label><br>
    <label><input type="checkbox" value="C" checked> C</label><br>
    <label><input type="checkbox" value="B" checked> B</label><br>
    <label><input type="checkbox" value="A" checked> A</label><br>
    <label><input type="checkbox" value="No Data" checked> No Data</label><br>
  </div>
  <div id="reachFilter">
    <strong>Filter by Reach:</strong><br>
    <div id="reachCheckboxes">Loading reaches...</div>
  </div>
  <div id="layerToggle">
    <label><input type="checkbox" id="toggleSubwatersheds"> Show Subwatersheds</label>
  </div>
  <div id="map"></div>
  <div class="legend">
    <h4>Reach Grades</h4>
    <div><i style="background:red"></i> F – Non-Functional</div>
    <div><i style="background:orange"></i> D – Impaired</div>
    <div><i style="background:yellow"></i> C – Functional</div>
    <div><i style="background:lightgreen"></i> B – Highly Functional</div>
    <div><i style="background:green"></i> A – Optimally Functional</div>
    <div><i style="background:gray"></i> No Data</div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vROJntSYDQdg2vU1VTlMy8E-qOsSe9wr5_JMj1n1ks2wonNsk-JippjXmzizJJ9_BfgwMzzBV0Af50h/pub?gid=61075690&single=true&output=csv";
    const geoJsonUrl = "https://calaneve.github.io/streammap/LBD_ReachCharacterization_GCSWGS84.geojson";
    const gradeColors = { 'F': 'red', 'D': 'orange', 'C': 'yellow', 'B': 'lightgreen', 'A': 'green', 'No Data': 'gray' };

    let map = L.map('map').setView([40.1, -105.87], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let geoLayer, reachGrades = {}, selectedColumn = "";

    function setupDropdown(headers) {
      const dropdown = document.getElementById("gradeColumn");
      dropdown.innerHTML = "";
      for (let i = 2; i < headers.length; i++) {
        const opt = document.createElement("option");
        opt.value = opt.textContent = headers[i];
        dropdown.appendChild(opt);
      }
      selectedColumn = dropdown.value = dropdown.options[0].value;
      dropdown.addEventListener("change", () => selectedColumn = dropdown.value);
    }

    function setupReachCheckboxes(reaches) {
      const container = document.getElementById("reachCheckboxes");
      container.innerHTML = "";
      reaches.sort().forEach(reach => {
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = reach;
        checkbox.checked = true;
        const label = document.createElement("label");
        label.appendChild(checkbox);
        label.append(" " + reach);
        container.appendChild(label);
        container.appendChild(document.createElement("br"));
      });
    }

    function updateGrades() {
      return fetch(csvUrl).then(r => r.text()).then(csv => {
        const lines = csv.trim().split("\n");
        const headers = lines[0].split(",");
        reachGrades = {};
        const allReaches = new Set();

        lines.slice(1).forEach(line => {
          const cols = line.split(",");
          const reach = cols[0].trim();
          const reach_id = cols[1].trim();
          reachGrades[reach_id] = { reach };

          for (let i = 2; i < headers.length; i++) {
            let g = (cols[i] || "").trim().toUpperCase();
            if (!gradeColors[g]) g = "No Data";
            reachGrades[reach_id][headers[i]] = g;
          }

          const colIndex = headers.indexOf(selectedColumn);
          let selectedGrade = (cols[colIndex] || "").trim().toUpperCase();
          if (!gradeColors[selectedGrade]) selectedGrade = "No Data";
          reachGrades[reach_id].color = gradeColors[selectedGrade];
          reachGrades[reach_id].grade = selectedGrade;

          allReaches.add(reach);
        });

        setupDropdown(headers);
        setupReachCheckboxes([...allReaches]);
      });
    }

    function reloadGeoLayer() {
      fetch(geoJsonUrl).then(res => res.json()).then(data => {
        if (geoLayer) map.removeLayer(geoLayer);

        geoLayer = L.geoJSON(data, {
          style: f => {
            const record = reachGrades[f.properties.reach_id] || {};
            return { color: record.color || 'gray', weight: 6 };
          },
          onEachFeature: (feature, layer) => {
            layer.on("mouseover", () => {
              const id = feature.properties.reach_id;
              const record = reachGrades[id];
              if (!record) return;

              let popupContent = `<strong>Reach ID: ${id}</strong><br><table>`;
              for (const key in record) {
                if (!['reach', 'color', 'grade'].includes(key)) {
                  const grade = record[key];
                  const keyStyled = key === selectedColumn ? `<strong style=\"color:blue;\">${key}</strong>` : key;
                  const gradeStyled = key === selectedColumn ? `<strong style=\"color:blue;\">${grade}</strong>` : grade;
                  popupContent += `<tr><td>${keyStyled}</td><td>=</td><td>${gradeStyled}</td></tr>`;
                }
              }
              popupContent += `</table>`;
              layer.bindTooltip(popupContent, { sticky: true }).openTooltip();
            });
            layer.on("mouseout", () => layer.closeTooltip());
          }
        }).addTo(map);

        geoLayer.bringToFront();
        const bounds = geoLayer.getBounds();
        if (bounds.isValid()) map.fitBounds(bounds, { padding: [20, 20] });
      });
    }

    document.getElementById("updateButton").addEventListener("click", () => {
      updateGrades().then(() => reloadGeoLayer());
    });

    document.getElementById("searchBox").addEventListener("input", function () {
      const query = this.value.trim().toLowerCase();
      geoLayer.eachLayer(layer => {
        const id = layer.feature.properties.reach_id || "";
        const match = id.toLowerCase().includes(query);
        const record = reachGrades[id] || {};
        const originalColor = record.color || "gray";
        layer.setStyle({ color: match ? 'blue' : originalColor, weight: match ? 8 : 6 });
        if (match && query !== "") layer.openTooltip();
        else layer.closeTooltip();
      });
    });

    // Initial load
    updateGrades().then(() => reloadGeoLayer());
  </script>
</body>
</html>




